<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title th:text="${titulo}">Pacientes</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/styles_list.css}">


</head>

<body>
<div class="sidebar-container" th:insert="fragments/sidebar :: sidebar"></div>

<div class="sidebar-main-content">

    <div class="d-flex justify-content-between align-items-center page-header-wrapper px-4">

        <h1 class="page-title my-4" >Pacientes</h1>

        <a class="btn btn-success" th:href="@{/pacientes/nuevo}">
            <i class="fa-solid fa-plus"></i> Agregar Paciente
        </a>

    </div>


    <div class="list-main-content container-fluid px-4">

        <div class="search-container mb-3">
            <form class="d-flex mb-3" th:action="@{/pacientes/buscar}" method="get">
                <input id="searchInput" class="form-control search-input me-2" type="text" name="q" placeholder="Buscar paciente..." th:value="${palabra}">
                <button class="btn btn-search" type="submit">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
                <a class="btn-all ms-2" th:href="@{/pacientes/listar}">Ver todos</a>
            </form>
        </div>

        <div class="row" th:each="paciente : ${pacientes}">
            <div class="col-12 mb-4">

                <div class="card card-parent p-3">
                    <div class="card-body">

                        <div class="row g-3">

                            <div class="col-md-4">
                                <div class="subcard personal-data">
                                    <div class="subcard-header d-flex justify-content-between align-items-center">
                                        <h5>Datos Personales</h5>
                                        <div class="header-icons d-flex gap-2">
                                            <a th:href="@{'/pacientes/editar/' + ${paciente.idPaciente}}" class="btn-edit">
                                                <i class="fa-solid fa-pen"></i>
                                            </a>
                                            <a th:href="@{'/pacientes/eliminar/' + ${paciente.idPaciente}}" class="btn-delete"
                                               onclick="return confirm('¿Seguro que deseas eliminar este paciente?')">
                                                <i class="fa-solid fa-trash"></i>
                                            </a>
                                            <!--<a th:href="@{'/pacientes/detalle/' + ${paciente.idPaciente}}" class="btn-view">
                                                <i class="fa-solid fa-eye"></i>
                                            </a>-->
                                        </div>
                                    </div>

                                    <div class="subcard-field">
                                        <span class="field-label">Nombre:</span>
                                        <span class="field-value" th:text="${paciente.nombres + ' ' + paciente.apellidos}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">DNI:</span>
                                        <span class="field-value" th:text="${paciente.dni}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">Dirección:</span>
                                        <span class="field-value" th:text="${paciente.direccion}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">Sexo:</span>
                                        <span class="field-value" th:text="${paciente.sexo}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">Correo:</span>
                                        <span class="field-value" th:text="${paciente.correo}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">Teléfono:</span>
                                        <span class="field-value" th:text="${paciente.telefono}"></span>
                                    </div>
                                    <div class="subcard-field">
                                        <span class="field-label">Estado:</span>
                                        <span class="field-value" th:text="${paciente.estado}"></span>
                                    </div>
                                </div>
                            </div>


                            <div class="col-md-8">

                                <div class="subcard p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>Historia Clínica</h5>

                                        <a th:if="${paciente.historiaClinica.observaciones != null and #strings.length(paciente.historiaClinica.observaciones) > 150}"
                                           href="#"
                                           data-bs-toggle="modal"
                                           th:attr="data-bs-target='#observacionesModal' + ${paciente.idPaciente}"
                                           class="btn-view header-icons-hc"><i class="fa-solid fa-file-lines"></i>
                                        </a>
                                    </div>

                                    <p><strong>ID Historia:</strong> <span th:text="${paciente.historiaClinica.idHistoria}"></span></p>
                                    <p><strong>Fecha de Apertura:</strong> <span th:text="${paciente.historiaClinica.fechaApertura}"></span></p>

                                    <p>
                                        <strong>Observaciones:</strong>
                                        <span th:with="obs=${paciente.historiaClinica.observaciones}">
                                            <span th:if="${obs == null or #strings.isEmpty(obs)}">
                                                Sin observaciones registradas
                                            </span>
                                            <span th:unless="${obs == null or #strings.isEmpty(obs)}">
                                                <span th:text="${#strings.length(obs) > 150 ? #strings.substring(obs, 0, 150) + '...' : obs}"></span>

                                            </span>
                                        </span>
                                    </p>
                                </div>

                                <div class="subcard p-3 antecedentes-card">

                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>Antecedentes Médicos</h5>
                                        <a th:href="@{'/pacientes/' + ${paciente.idPaciente} + '/antecedentes/nuevo'}" class="btn btn-sm btn-outline-success">
                                            <i class="fa-solid fa-notes-medical"></i> Agregar
                                        </a>
                                    </div>

                                    <div th:if="${#lists.isEmpty(paciente.historiaClinica.antecedentes)}">
                                        <div class="alert alert-light text-center text-muted border py-3" role="alert">
                                            <i class="fa-solid fa-file-circle-exclamation me-2"></i> No hay antecedentes médicos registrados.
                                        </div>
                                    </div>

                                    <div th:unless="${#lists.isEmpty(paciente.historiaClinica.antecedentes)}">

                                        <table class="table table-sm table-borderless table-antecedentes">
                                            <thead>
                                            <tr>
                                                <th style="width: 10%;">ID</th>
                                                <th style="width: 25%;">Tipo</th>
                                                <th style="width: 45%;">Descripción</th>
                                                <th style="width: 20%;" class="text-end">Acciones</th>
                                            </tr>
                                            </thead>
                                            <tbody>

                                            <tr th:each="antecedente, iterStat : ${paciente.historiaClinica.antecedentes}"
                                                th:if="${iterStat.index < 2}"> <td class="text-muted" th:text="${antecedente.idAntecedente}"></td>

                                                <td th:with="tipo=${antecedente.tipo}">
                                                    <span class="badge bg-secondary" th:text="${#strings.length(tipo) > 20 ? #strings.substring(tipo, 0, 20) + '...' : tipo}"></span>
                                                </td>

                                                <td th:with="desc=${antecedente.descripcion}">
                                                    <span th:text="${#strings.length(desc) > 50 ? #strings.substring(desc, 0, 50) + '...' : desc}"></span>
                                                </td>

                                                <td class="text-end">
                                                    <a th:href="@{'/pacientes/' + ${paciente.idPaciente} + '/antecedentes/editar/' + ${antecedente.idAntecedente}}"
                                                       class="btn btn-icon btn-sm btn-edit-antecedente me-1" title="Editar">
                                                        <i class="fa-solid fa-pen"></i>
                                                    </a>
                                                    <a th:href="@{'/pacientes/' + ${paciente.idPaciente} + '/antecedentes/eliminar/' + ${antecedente.idAntecedente}}"
                                                       class="btn btn-icon btn-sm btn-delete-antecedente" title="Eliminar"
                                                       onclick="return confirm('¿Seguro que deseas eliminar este antecedente?')">
                                                        <i class="fa-solid fa-trash-can"></i>
                                                    </a>
                                                </td>
                                            </tr>

                                            <tr th:if="${#lists.size(paciente.historiaClinica.antecedentes) > 3}" class="table-summary-row">
                                                <td colspan="4" class="text-center p-0 pt-2">
                                                    <button type="button"
                                                            class="btn btn-link btn-sm text-primary w-100"
                                                            data-bs-toggle="modal"
                                                            th:attr="data-bs-target='#antecedentesListModal' + ${paciente.idPaciente}">
                                                        Ver los <span th:text="${#lists.size(paciente.historiaClinica.antecedentes)}"></span> registros completos <i class="fa-solid fa-arrow-right-long ms-1"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" th:id="'observacionesModal' + ${paciente.idPaciente}" tabindex="-1" aria-labelledby="observacionesModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="observacionesModalLabel">Observaciones de Historia Clínica: <span th:text="${paciente.nombres + ' ' + paciente.apellidos}"></span></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p th:text="${paciente.historiaClinica.observaciones}"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" th:id="'antecedentesListModal' + ${paciente.idPaciente}" tabindex="-1" aria-labelledby="antecedentesListModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="antecedentesListModalLabel">Historial Completo de Antecedentes Médicos</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="antecedente : ${paciente.historiaClinica.antecedentes}">
                                    <td th:text="${antecedente.idAntecedente}"></td>
                                    <td th:text="${antecedente.tipo}"></td>
                                    <td th:text="${antecedente.descripcion}"></td>
                                    <td>
                                        <a th:href="@{'/pacientes/' + ${paciente.idPaciente} + '/antecedentes/editar/' + ${antecedente.idAntecedente}}"
                                           class="btn btn-sm btn-primary">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>
                                        <a th:href="@{'/pacientes/' + ${paciente.idPaciente} + '/antecedentes/eliminar/' + ${antecedente.idAntecedente}}"
                                           class="btn btn-sm btn-danger" onclick="return confirm('¿Eliminar?')">
                                            <i class="fa-solid fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>